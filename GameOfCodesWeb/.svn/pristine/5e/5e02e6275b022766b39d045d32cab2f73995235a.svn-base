package com.misys.gameofcodes.dao;

import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import org.bson.BasicBSONObject;
import org.bson.types.ObjectId;

import com.misys.gameofcodes.connection.CollectionProvider;
import com.misys.gameofcodes.model.Hero;
import com.misys.gameofcodes.model.House;
import com.misys.gameofcodes.service.HeroService;
import com.misys.gameofcodes.utility.EncoderUtility;
import com.mongodb.BasicDBObject;
import com.mongodb.DB;
import com.mongodb.DBCollection;
import com.mongodb.DBCursor;
import com.mongodb.DBObject;

public class HousesDAOImpl implements HousesDAO {

	private CollectionProvider collectionProvider;
	
	public HousesDAOImpl() 
	{
		collectionProvider = new CollectionProvider();
		
	}
	
	@Override
	public Map<String, House> getAllHouses() {
        DBCursor cursor = collectionProvider.getHouseCollection().find();
        Map<String, House> houses= new HashMap<String, House>();
        while(cursor.hasNext()){
    		House h = new House();
        	DBObject dbhouse = cursor.next();
        	System.out.println(dbhouse.toString());
        }
		return null;
	}

	@Override
	public House getHouse(House house) {
	    BasicDBObject query = new BasicDBObject();
	    query.put("_id", house.getId());
	    DBObject dbHouse = collectionProvider.getHouseCollection().findOne(query);
	    return getHouse(dbHouse);
	}

	public House getHouse(DBObject dbHouse) {
		House house = new House();
    	ObjectId objId = (ObjectId) dbHouse.get("_id");
    	house.setId(objId);
    	house.setHousename(dbHouse.get("housename").toString());
    	house.setDomain(dbHouse.get("domain").toString());
    	house.setBanner(dbHouse.get("banner").toString());
    	return house;
	}
	@Override
	public void addHouse(House house) {
		DBCollection houseCollection = collectionProvider.getHouseCollection();
		BasicDBObject houseObject = new BasicDBObject("housename", house.getHousename())
				.append("domain", house.getDomain())  
				.append("banner", house.getBanner());
		System.out.println(houseCollection.insert(houseObject));
	}

	@Override
	public void updateHouse(House house) {
		DBCollection houseCollection = collectionProvider.getHouseCollection();
	    BasicDBObject query = new BasicDBObject();
	    query.put("_id", house.getId());

	    DBObject dbHouse = collectionProvider.getHouseCollection().findOne(query);
	    	dbHouse.put("housename",house.getHousename());
	    	houseCollection.update(query, dbHouse); 
		
	}

	@Override
	public void deleteHouse(House house) {
		DBCollection houseCollection = collectionProvider.getHouseCollection();
		BasicDBObject query = new BasicDBObject("_id", house.getId());
		System.out.println(houseCollection.remove(query));
	}

	@Override
	public void addHouseHero(House house, Hero hero) {
		DBCollection houseCollection = collectionProvider.getHouseCollection();
	    BasicDBObject query = new BasicDBObject();
	    query.put("_id", house.getId());
	    hero = HeroService.getHeroService().fetchHero(hero);
		BasicDBObject heroesObject = new BasicDBObject("_id",hero.getId())
				.append("name", hero.getName())
				.append("email", hero.getEmail())
				.append("username", hero.getUsername());
	    
	    DBObject dbHouse = collectionProvider.getHouseCollection().findOne(query);
	    	List<BasicDBObject> heroesList = (List<BasicDBObject>) dbHouse.get("heroes");
	    	heroesList.add(heroesObject);
	    dbHouse.put("heroes", heroesList);
	    
		System.out.println(houseCollection.update(query, dbHouse));
		
	}




}

